
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/plot_compare_jax_scipy.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_examples_plot_compare_jax_scipy.py>`
        to download the full example code.

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_plot_compare_jax_scipy.py:


Compare `JAX` and `Scipy`
=========================

This example compares the `JAX` and `Scipy` implementations of the
interpolation backend.

.. GENERATED FROM PYTHON SOURCE LINES 9-18

.. code-block:: Python


    import jax.numpy as jnp
    import numpy as np
    from time import time
    import matplotlib.pyplot as plt
    from astropy import units as u

    from GridPolator import GridSpectra








.. GENERATED FROM PYTHON SOURCE LINES 19-21

First let's get the spectra
-----------------------------

.. GENERATED FROM PYTHON SOURCE LINES 21-47

.. code-block:: Python


    w1 = 5 * u.um
    w2 = 12 * u.um
    resolving_power = 100
    teffs = [2800,2900,3000,3100,3200,3300]
    impl_bin = 'rust'

    g_jax = GridSpectra.from_vspec(
        w1=w1,
        w2=w2,
        resolving_power=resolving_power,
        teffs=teffs,
        impl_bin=impl_bin,
        impl_interp='jax',
        fail_on_missing=False
    )
    g_scipy = GridSpectra.from_vspec(
        w1=w1,
        w2=w2,
        resolving_power=resolving_power,
        teffs=teffs,
        impl_bin=impl_bin,
        impl_interp='scipy',
        fail_on_missing=False
    )





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Loading Spectra:   0%|          | 0/6 [00:00<?, ?it/s]PHOENIX grid for 2800 not found. Downloading...

    Downloading teff=2800:   0%|          | 0.00/33.9M [00:00<?, ?B/s]
    Downloading teff=2800:   0%|          | 4.10k/33.9M [00:00<53:06, 10.6kB/s]
    Downloading teff=2800:   0%|          | 45.1k/33.9M [00:00<04:46, 118kB/s] 
    Downloading teff=2800:   0%|          | 123k/33.9M [00:00<02:18, 243kB/s] 
    Downloading teff=2800:   1%|▏         | 500k/33.9M [00:00<00:30, 1.09MB/s]
    Downloading teff=2800:   4%|▎         | 1.25M/33.9M [00:00<00:14, 2.25MB/s]
    Downloading teff=2800:   9%|▉         | 3.20M/33.9M [00:01<00:04, 6.22MB/s]
    Downloading teff=2800:  19%|█▉        | 6.57M/33.9M [00:01<00:02, 13.0MB/s]
    Downloading teff=2800:  29%|██▉       | 9.98M/33.9M [00:01<00:01, 18.5MB/s]
    Downloading teff=2800:  38%|███▊      | 12.9M/33.9M [00:01<00:01, 17.6MB/s]
    Downloading teff=2800:  48%|████▊     | 16.3M/33.9M [00:01<00:00, 21.5MB/s]
    Downloading teff=2800:  58%|█████▊    | 19.8M/33.9M [00:01<00:00, 24.9MB/s]
    Downloading teff=2800:  69%|██████▉   | 23.4M/33.9M [00:01<00:00, 27.9MB/s]
    Downloading teff=2800:  78%|███████▊  | 26.4M/33.9M [00:01<00:00, 23.4MB/s]
    Downloading teff=2800:  88%|████████▊ | 30.0M/33.9M [00:02<00:00, 26.4MB/s]
    Downloading teff=2800:  98%|█████████▊| 33.4M/33.9M [00:02<00:00, 28.3MB/s]    Downloading teff=2800: 100%|██████████| 33.9M/33.9M [00:02<00:00, 15.9MB/s]
    Loading Spectra:  17%|█▋        | 1/6 [00:02<00:14,  2.80s/it]PHOENIX grid for 2900 not found. Downloading...

    Downloading teff=2900:   0%|          | 0.00/33.8M [00:00<?, ?B/s]
    Downloading teff=2900:   0%|          | 4.10k/33.8M [00:01<3:14:44, 2.90kB/s]
    Downloading teff=2900:   0%|          | 41.0k/33.8M [00:01<16:44, 33.6kB/s]  
    Downloading teff=2900:   1%|          | 209k/33.8M [00:01<02:55, 192kB/s]  
    Downloading teff=2900:   3%|▎         | 881k/33.8M [00:01<00:33, 993kB/s]
    Downloading teff=2900:   5%|▌         | 1.80M/33.8M [00:02<00:16, 1.96MB/s]
    Downloading teff=2900:  12%|█▏        | 4.23M/33.8M [00:02<00:05, 5.50MB/s]
    Downloading teff=2900:  23%|██▎       | 7.65M/33.8M [00:02<00:02, 10.8MB/s]
    Downloading teff=2900:  32%|███▏      | 10.8M/33.8M [00:02<00:01, 15.2MB/s]
    Downloading teff=2900:  42%|████▏     | 14.2M/33.8M [00:02<00:01, 16.5MB/s]
    Downloading teff=2900:  52%|█████▏    | 17.7M/33.8M [00:02<00:00, 20.5MB/s]
    Downloading teff=2900:  62%|██████▏   | 21.0M/33.8M [00:02<00:00, 23.3MB/s]
    Downloading teff=2900:  72%|███████▏  | 24.4M/33.8M [00:02<00:00, 26.2MB/s]
    Downloading teff=2900:  83%|████████▎ | 28.0M/33.8M [00:02<00:00, 28.6MB/s]
    Downloading teff=2900:  93%|█████████▎| 31.6M/33.8M [00:03<00:00, 25.4MB/s]    Downloading teff=2900: 100%|██████████| 33.8M/33.8M [00:03<00:00, 10.7MB/s]
    Loading Spectra:  33%|███▎      | 2/6 [00:06<00:13,  3.43s/it]    Loading Spectra:  50%|█████     | 3/6 [00:06<00:06,  2.00s/it]    Loading Spectra:  67%|██████▋   | 4/6 [00:07<00:02,  1.33s/it]    Loading Spectra:  83%|████████▎ | 5/6 [00:07<00:00,  1.04it/s]PHOENIX grid for 3300 not found. Downloading...

    Downloading teff=3300:   0%|          | 0.00/33.6M [00:00<?, ?B/s]
    Downloading teff=3300:   0%|          | 4.10k/33.6M [00:00<1:20:10, 6.97kB/s]
    Downloading teff=3300:   0%|          | 45.1k/33.6M [00:00<07:40, 72.8kB/s]  
    Downloading teff=3300:   1%|          | 184k/33.6M [00:00<01:42, 326kB/s]  
    Downloading teff=3300:   1%|▏         | 471k/33.6M [00:01<00:44, 736kB/s]
    Downloading teff=3300:   4%|▍         | 1.47M/33.6M [00:01<00:12, 2.63MB/s]
    Downloading teff=3300:  10%|▉         | 3.32M/33.6M [00:01<00:04, 6.25MB/s]
    Downloading teff=3300:  16%|█▌        | 5.25M/33.6M [00:01<00:04, 6.77MB/s]
    Downloading teff=3300:  26%|██▌       | 8.64M/33.6M [00:01<00:02, 12.2MB/s]
    Downloading teff=3300:  31%|███       | 10.3M/33.6M [00:02<00:03, 6.73MB/s]
    Downloading teff=3300:  40%|███▉      | 13.4M/33.6M [00:02<00:01, 10.1MB/s]
    Downloading teff=3300:  51%|█████     | 17.1M/33.6M [00:02<00:01, 14.6MB/s]
    Downloading teff=3300:  60%|██████    | 20.2M/33.6M [00:02<00:00, 17.5MB/s]
    Downloading teff=3300:  70%|███████   | 23.6M/33.6M [00:02<00:00, 21.1MB/s]
    Downloading teff=3300:  81%|████████  | 27.2M/33.6M [00:02<00:00, 24.4MB/s]
    Downloading teff=3300:  90%|████████▉ | 30.2M/33.6M [00:02<00:00, 22.6MB/s]    Downloading teff=3300: 100%|██████████| 33.6M/33.6M [00:02<00:00, 11.5MB/s]
    Loading Spectra: 100%|██████████| 6/6 [00:11<00:00,  1.85s/it]    Loading Spectra: 100%|██████████| 6/6 [00:11<00:00,  1.86s/it]
    Loading Spectra:   0%|          | 0/6 [00:00<?, ?it/s]    Loading Spectra:  17%|█▋        | 1/6 [00:00<00:01,  3.33it/s]    Loading Spectra:  33%|███▎      | 2/6 [00:00<00:01,  3.33it/s]    Loading Spectra:  50%|█████     | 3/6 [00:00<00:00,  3.33it/s]    Loading Spectra:  67%|██████▋   | 4/6 [00:01<00:00,  3.33it/s]    Loading Spectra:  83%|████████▎ | 5/6 [00:01<00:00,  3.33it/s]    Loading Spectra: 100%|██████████| 6/6 [00:01<00:00,  3.33it/s]    Loading Spectra: 100%|██████████| 6/6 [00:01<00:00,  3.33it/s]




.. GENERATED FROM PYTHON SOURCE LINES 48-50

Evaluate a single spectrum
---------------------------

.. GENERATED FROM PYTHON SOURCE LINES 50-66

.. code-block:: Python


    wl_jnp = jnp.linspace(5.0, 11.2, 100)
    wl_np = np.linspace(5.0, 11.2, 100)
    params_jnp = (jnp.array([2900.]),)
    params_np = (np.array([2900.]),)

    start = time()
    flux_jnp = g_jax.evaluate(params_jnp, wl_jnp)
    end = time()
    print(f'JAX took {end - start} seconds')

    start = time()
    flux_np = g_scipy.evaluate(params_np, wl_np)
    end = time()
    print(f'Scipy took {end - start} seconds')





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    JAX took 4.853564977645874 seconds
    Scipy took 0.004877328872680664 seconds




.. GENERATED FROM PYTHON SOURCE LINES 67-69

Now do 1000 of each
-------------------

.. GENERATED FROM PYTHON SOURCE LINES 69-83

.. code-block:: Python


    N = 1000
    start = time()
    for _ in range(N):
        flux_jnp = g_jax.evaluate(params_jnp, wl_jnp)
    end = time()
    print(f'JAX took {end - start} seconds\n\tthat\'s {(end - start) / 1000} seconds per call')

    start = time()
    for _ in range(N):
        flux_np = g_scipy.evaluate(params_np, wl_np)
    end = time()
    print (f'Scipy took {end - start} seconds\n\tthat\'s {(end - start) / 1000} seconds per call')





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    JAX took 0.34310388565063477 seconds
            that's 0.0003431038856506348 seconds per call
    Scipy took 4.46177864074707 seconds
            that's 0.00446177864074707 seconds per call




.. GENERATED FROM PYTHON SOURCE LINES 84-89

QED
---

The takeaway: The first JAX call is expensive, the rest are cheap. For Scipy everything costs the same.
Of course, the costs change depending on the complexity of the grid.

.. GENERATED FROM PYTHON SOURCE LINES 89-137

.. code-block:: Python


    fig, ax  = plt.subplots(1,1,figsize=(4,3))

    N=3000

    g_jax = GridSpectra.from_vspec(
        w1=w1,
        w2=w2,
        resolving_power=resolving_power,
        teffs=teffs,
        impl_bin=impl_bin,
        impl_interp='jax',
        fail_on_missing=False
    )
    g_scipy = GridSpectra.from_vspec(
        w1=w1,
        w2=w2,
        resolving_power=resolving_power,
        teffs=teffs,
        impl_bin=impl_bin,
        impl_interp='scipy',
        fail_on_missing=False
    )

    dt_jax = np.zeros(N)

    for i in range(N):
        start = time()
        flux_jnp = g_jax.evaluate(params_jnp, wl_jnp)
        end = time()
        dt_jax[i] = end - start

    dt_scipy = np.zeros(N)

    for i in range(N):
        start = time()
        flux_np = g_scipy.evaluate(params_np, wl_np)
        end = time()
        dt_scipy[i] = end - start

    x = np.arange(N)

    ax.plot(x, np.cumsum(dt_jax), label='JAX',c='#B96EBD')
    ax.plot(x, np.cumsum(dt_scipy), label='Scipy',c='#0054A6')
    ax.set_xlabel('Iteration')
    ax.set_ylabel('Time (s)')
    fig.tight_layout()
    _=ax.legend()



.. image-sg:: /auto_examples/images/sphx_glr_plot_compare_jax_scipy_001.png
   :alt: plot compare jax scipy
   :srcset: /auto_examples/images/sphx_glr_plot_compare_jax_scipy_001.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Loading Spectra:   0%|          | 0/6 [00:00<?, ?it/s]    Loading Spectra:  17%|█▋        | 1/6 [00:00<00:01,  3.37it/s]    Loading Spectra:  33%|███▎      | 2/6 [00:00<00:01,  3.36it/s]    Loading Spectra:  50%|█████     | 3/6 [00:00<00:00,  3.36it/s]    Loading Spectra:  67%|██████▋   | 4/6 [00:01<00:00,  3.34it/s]    Loading Spectra:  83%|████████▎ | 5/6 [00:01<00:00,  3.35it/s]    Loading Spectra: 100%|██████████| 6/6 [00:01<00:00,  3.35it/s]    Loading Spectra: 100%|██████████| 6/6 [00:01<00:00,  3.35it/s]
    Loading Spectra:   0%|          | 0/6 [00:00<?, ?it/s]    Loading Spectra:  17%|█▋        | 1/6 [00:00<00:01,  3.36it/s]    Loading Spectra:  33%|███▎      | 2/6 [00:00<00:01,  3.36it/s]    Loading Spectra:  50%|█████     | 3/6 [00:00<00:00,  3.36it/s]    Loading Spectra:  67%|██████▋   | 4/6 [00:01<00:00,  3.36it/s]    Loading Spectra:  83%|████████▎ | 5/6 [00:01<00:00,  3.36it/s]    Loading Spectra: 100%|██████████| 6/6 [00:01<00:00,  3.27it/s]    Loading Spectra: 100%|██████████| 6/6 [00:01<00:00,  3.32it/s]





.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 46.011 seconds)


.. _sphx_glr_download_auto_examples_plot_compare_jax_scipy.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_compare_jax_scipy.ipynb <plot_compare_jax_scipy.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_compare_jax_scipy.py <plot_compare_jax_scipy.py>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
